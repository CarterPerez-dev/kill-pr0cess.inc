# Development Dockerfile for the Rust backend with hot reload and debugging capabilities.
# I'm optimizing for development speed with volume mounting and cargo watch for automatic rebuilds.

FROM rust:1.81-slim

# I'm installing development dependencies including cargo-watch for hot reload
RUN apt-get update && apt-get install -y \
    pkg-config \
    libssl-dev \
    libpq-dev \
    build-essential \
    git \
    curl \
    postgresql-client \
    redis-tools \
    && rm -rf /var/lib/apt/lists/*

# I'm installing cargo-watch for automatic rebuilds during development
RUN cargo install cargo-watch

# I'm creating a development user for security
RUN useradd -m -u 1001 -s /bin/bash developer
USER developer
WORKDIR /app

COPY --chown=developer:developer Cargo.toml ./Cargo.toml
RUN cargo generate-lockfile
COPY --chown=developer:developer build.rs ./

# I'm creating a dummy src to cache dependencies
RUN mkdir src && echo "fn main() {}" > src/main.rs
RUN cargo build
RUN rm -rf src

# I'm setting development environment variables
ENV RUST_LOG=debug
ENV RUST_BACKTRACE=1
ENV ENVIRONMENT=development
ENV PORT=3001

# I'm exposing the development port
EXPOSE 3001

# I'm using cargo-watch for hot reload during development
CMD ["cargo", "watch", "-x", "run"]
